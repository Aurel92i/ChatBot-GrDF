<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assistant Astreinte GRDF</title>
  <style>
    :root {
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      color-scheme: light;
      --blue-500: #0a75d1;
      --blue-600: #0a5fb0;
      --blue-700: #094f94;
      --green-500: #17a398;
      --amber-500: #f5a623;
      --red-500: #d1433d;
      --gray-50: #f5f7fb;
      --gray-100: #eef1f7;
      --gray-200: #d9deeb;
      --gray-700: #3a4a69;
      --shadow-soft: 0 10px 35px rgba(10, 117, 209, 0.15);
      --radius-lg: 18px;
      --radius-sm: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(10, 117, 209, 0.14), transparent 50%),
                  radial-gradient(circle at 80% 25%, rgba(23, 163, 152, 0.14), transparent 55%),
                  linear-gradient(160deg, #ffffff 0%, #f3f6fb 50%, #edf2fb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
      color: #1c2740;
    }
    .layout {
      position: relative;
      width: min(1040px, 100%);
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 24px;
    }

    .chat-container {
      background: #ffffff;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      min-height: 620px;
      overflow: hidden;
    }

    .chat-header {
      padding: 24px;
      background: linear-gradient(135deg, var(--blue-500), var(--blue-700));
      color: #ffffff;
      position: relative;
    }

    .chat-header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }

    .chat-header p {
      margin: 8px 0 0;
      font-size: 14px;
      opacity: 0.92;
      max-width: 520px;
      line-height: 1.5;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.18);
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      margin-top: 16px;
    }

    .status-pill span {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #6df06d;
      border-radius: 50%;
      box-shadow: 0 0 0 2px rgba(109, 240, 109, 0.3);
    }
    .tab-tray {
      display: flex;
      gap: 12px;
      padding: 16px 24px 14px;
      background: #f6f8fc;
      border-bottom: 1px solid var(--gray-200);
      flex-wrap: wrap;
    }

    .tab-tray button {
      border: none;
      background: #ffffff;
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      font-size: 13px;
      color: var(--blue-600);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: inset 0 0 0 1px rgba(10, 117, 209, 0.16);
    }

    .tab-tray button:hover,
    .tab-tray button:focus {
      background: rgba(10, 117, 209, 0.08);
      outline: none;
    }

    .messages {
      padding: 18px 26px 24px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .message {
      max-width: 86%;
      border-radius: 14px;
      padding: 14px 18px;
      line-height: 1.55;
      font-size: 14px;
      box-shadow: 0 10px 25px rgba(16, 39, 112, 0.08);
    }
    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--blue-500), var(--blue-700));
      color: #ffffff;
    }

    .message.bot {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid rgba(14, 64, 126, 0.12);
      color: #16223b;
    }

    .message.bot strong {
      color: var(--blue-600);
      font-weight: 600;
    }

    .message p {
      margin: 0 0 6px;
    }

    .message p:last-child {
      margin-bottom: 0;
    }

    .typing-indicator {
      display: inline-flex;
      gap: 6px;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--blue-500);
      opacity: 0.36;
      animation: bounce 1.2s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.7); opacity: 0.2; }
      40% { transform: scale(1); opacity: 0.6; }
    }
    .quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 0 24px 10px;
    }

    .quick-replies button {
      border: none;
      background: rgba(10, 117, 209, 0.12);
      color: var(--blue-700);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-replies button:hover {
      background: rgba(10, 117, 209, 0.2);
    }

    .composer {
      padding: 16px 24px 24px;
      border-top: 1px solid #e1e6f1;
      background: linear-gradient(180deg, #f9fbff 0%, #f0f4fb 100%);
      display: flex;
      gap: 12px;
      align-items: flex-end;
      position: relative;
    }

    .input-wrapper {
      flex: 1;
      background: #ffffff;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(16, 39, 112, 0.14);
      padding: 10px 14px;
      display: flex;
      gap: 10px;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    .input-wrapper:focus-within {
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px rgba(10, 117, 209, 0.18);
    }
    #userInput {
      border: none;
      flex: 1;
      font-size: 14px;
      outline: none;
      resize: none;
      max-height: 120px;
      font-family: inherit;
      background: transparent;
    }

    .send-button {
      background: linear-gradient(135deg, var(--blue-500), var(--blue-700));
      color: #ffffff;
      border: none;
      border-radius: var(--radius-sm);
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(10, 117, 209, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .send-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(10, 117, 209, 0.3);
    }

    .autocomplete {
      position: absolute;
      left: 38px;
      right: 170px;
      bottom: 80px;
      background: #ffffff;
      border: 1px solid rgba(11, 52, 109, 0.18);
      border-radius: var(--radius-sm);
      box-shadow: 0 16px 32px rgba(10, 117, 209, 0.18);
      display: none;
      flex-direction: column;
      max-height: 220px;
      overflow-y: auto;
      z-index: 5;
    }
    .autocomplete button {
      border: none;
      background: transparent;
      text-align: left;
      padding: 10px 14px;
      font-size: 13px;
      cursor: pointer;
      border-bottom: 1px solid rgba(12, 46, 92, 0.08);
    }

    .autocomplete button:hover,
    .autocomplete button:focus {
      background: rgba(10, 117, 209, 0.1);
      outline: none;
    }

    .bot-section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--blue-600);
      margin-bottom: 12px;
    }

    .answer-section {
      padding: 10px 0 6px;
    }

    .answer-section h4 {
      margin: 0 0 8px;
      font-size: 17px;
      color: var(--blue-600);
    }

    .answer-section p {
      margin: 0 0 12px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 12px;
      font-size: 13px;
    }

    .data-table thead {
      background: rgba(10, 117, 209, 0.1);
    }
    .data-table th,
    .data-table td {
      border: 1px solid rgba(12, 46, 92, 0.1);
      padding: 8px 10px;
      text-align: left;
    }

    .data-table th {
      font-weight: 600;
      color: var(--blue-700);
    }

    .checklist,
    .lead-list,
    .step-list {
      margin: 0 0 12px 0;
      padding-left: 18px;
    }

    .checklist li,
    .lead-list li,
    .step-list li {
      margin-bottom: 6px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(10, 117, 209, 0.12);
      color: var(--blue-600);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .badge.guide {
      background: rgba(23, 163, 152, 0.16);
      color: #117168;
    }

    .badge.norme {
      background: rgba(241, 181, 62, 0.18);
      color: #945a05;
    }

    .badge.memento {
      background: rgba(92, 110, 219, 0.18);
      color: #313c88;
    }
    .resource-list {
      margin: 0;
      padding-left: 18px;
    }

    .resource-list li {
      margin-bottom: 6px;
      font-size: 13px;
    }

    .resource-list span {
      margin-right: 8px;
    }

    .related-block {
      margin-top: 18px;
      padding-top: 14px;
      border-top: 1px solid rgba(12, 46, 92, 0.1);
    }

    .related-block h5 {
      margin: 0 0 10px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--gray-700);
    }

    .related-block button {
      display: inline-flex;
      margin: 4px 6px 4px 0;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(10, 117, 209, 0.2);
      background: rgba(10, 117, 209, 0.06);
      color: var(--blue-600);
      font-size: 12px;
      cursor: pointer;
    }

    .related-block button:hover {
      background: rgba(10, 117, 209, 0.14);
    }
    .knowledge-panel {
      position: fixed;
      top: 32px;
      right: 32px;
      width: min(360px, 90vw);
      max-height: calc(100vh - 64px);
      background: rgba(255, 255, 255, 0.98);
      border-radius: var(--radius-lg);
      box-shadow: 0 24px 60px rgba(16, 39, 112, 0.2);
      transform: translateX(120%);
      transition: transform 0.4s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 20;
    }

    .knowledge-panel.open {
      transform: translateX(0);
    }

    .panel-header {
      padding: 20px 22px 16px;
      background: linear-gradient(135deg, var(--green-500), var(--blue-500));
      color: #ffffff;
    }

    .panel-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .panel-header p {
      margin: 8px 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .close-panel {
      position: absolute;
      top: 16px;
      right: 16px;
      border: none;
      background: rgba(255, 255, 255, 0.18);
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .panel-body {
      padding: 18px 22px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .panel-card {
      border: 1px solid rgba(12, 46, 92, 0.12);
      border-radius: 14px;
      padding: 14px 16px;
      background: #ffffff;
    }

    .panel-card h3 {
      margin: 0 0 8px;
      font-size: 16px;
      color: var(--blue-600);
    }

    .panel-card p {
      margin: 0 0 10px;
      font-size: 13px;
    }

    .panel-card button {
      border: none;
      background: rgba(10, 117, 209, 0.14);
      color: var(--blue-700);
      font-weight: 600;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .fab {
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: linear-gradient(135deg, var(--green-500), var(--blue-500));
      color: #ffffff;
      border: none;
      border-radius: 999px;
      padding: 14px 20px;
      font-weight: 600;
      box-shadow: 0 18px 36px rgba(16, 39, 112, 0.25);
      cursor: pointer;
      z-index: 10;
      display: inline-flex;
      gap: 10px;
      align-items: center;
    }

    .fab:hover {
      transform: translateY(-2px);
    }

    .disclaimer {
      font-size: 12px;
      opacity: 0.76;
      margin-top: 12px;
      border-top: 1px dashed rgba(16, 39, 112, 0.18);
      padding-top: 10px;
    }
    @media (max-width: 900px) {
      body {
        padding: 16px;
      }
      .layout {
        width: 100%;
      }
      .chat-container {
        min-height: 80vh;
      }
      .fab {
        right: 16px;
        bottom: 16px;
      }
      .knowledge-panel {
        top: 16px;
        right: 16px;
        width: calc(100% - 32px);
      }
      .composer {
        flex-direction: column;
        align-items: stretch;
      }
      .autocomplete {
        position: static;
        width: 100%;
        box-shadow: none;
        border-radius: var(--radius-sm);
      }
      .send-button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <section class="chat-container" aria-label="Assistant chantier GRDF">
      <header class="chat-header">
        <h1>Assistant Astreinte GRDF</h1>
        <p>Retrouvez les fiches diametres et les regles de securite </p>
        <div class="status-pill" aria-live="polite">
          <span></span>
          Références mises à jour 2025
        </div>
      </header>
      <div class="tab-tray" id="topicsTray" role="group" aria-label="Acces direct thematiques">
        <button type="button" data-query="diametre PE pour branchement">Diametres PE</button>
        <button type="button" data-query="diametre cuivre interieur">Diametres cuivre</button>
        <button type="button" data-query="diametre acier reseau gaz">Diametres acier</button>
        <button type="button" data-query="travaux publics obligations">Travaux publics</button>
        <button type="button" data-query="procedure fuite gaz chantier">Procedure fuite</button>
        <button type="button" data-query="checklist mise en gaz">Checklist mise en gaz</button>
      </div>

      <div class="messages" id="messages" role="log" aria-live="polite"></div>

      <div class="quick-replies" id="quickReplies" aria-label="Suggestions"></div>

      <div class="composer">
        <div class="input-wrapper">
          <textarea id="userInput" rows="1" placeholder="Posez votre question (ex. Quel diametre PE pour 40 m a 6 m3/h ?)" aria-label="Saisissez votre question"></textarea>
          <div class="autocomplete" id="autocomplete" role="listbox"></div>
        </div>
        <button class="send-button" id="sendButton" type="button">Envoyer</button>
      </div>
    </section>
  </div>

  <aside class="knowledge-panel" id="knowledgePanel" aria-hidden="true">
    <div class="panel-header">
      <h2>Fiches pratiques</h2>
      <p>Consultez les fiches detaillees hors conversation.</p>
      <button class="close-panel" type="button" id="closePanel">Fermer</button>
    </div>
    <div class="panel-body" id="panelBody"></div>
  </aside>

  <button class="fab" id="openPanel" type="button" aria-expanded="false">
    <span>Fiches pratiques</span>
  </button>

  <script>
    (function () {
      const STORAGE_KEY = "grdf-chat-v1";
      const messagesEl = document.getElementById("messages");
      const userInput = document.getElementById("userInput");
      const sendButton = document.getElementById("sendButton");
      const quickRepliesEl = document.getElementById("quickReplies");
      const topicsTray = document.getElementById("topicsTray");
      const autocompleteEl = document.getElementById("autocomplete");
      const openPanelBtn = document.getElementById("openPanel");
      const closePanelBtn = document.getElementById("closePanel");
      const panel = document.getElementById("knowledgePanel");
      const panelBody = document.getElementById("panelBody");

      const knowledgeBase = [
        {
          id: "diam-pe",
          title: "Diametres PE (polyethylene) reseau gaz",
          category: "Diametres",
          keywords: ["diametre pe", "pehd", "polyethylene", "branchements", "sdr11", "sdr17", "tuyau jaune", "soudures pe"],
          summary: "20,32,40,63,125,160",
          details: "<div class=\"answer-section\"><div class=\"bot-section-title\">Reperes rapides</div><table class=\"data-table\"><thead><tr><th>Usage</th><th>DN ext (mm)</th><th>Pression</th><th>Commentaire</th></tr></thead><tbody><tr><td>Branchement individuel &lt; 6 m3/h</td><td>25 ou 32</td><td>4 bar (SDR 11)</td><td>Preferez 32 mm si longueur &gt; 30 m</td></tr><tr><td>Collectif 10 a 25 m3/h</td><td>40 ou 50</td><td>4 bar</td><td>Tracer plan de recollement precis</td></tr><tr><td>Distribution secondaire 25 a 65 m3/h</td><td>63 ou 75</td><td>4 bar</td><td>Reserver zones de soudure</td></tr><tr><td>Renforcement ou boucle reseau</td><td>90 a 125</td><td>4 bar</td><td>Controle ovalisation et compaction</td></tr><tr><td>Moyenne pression locale</td><td>160</td><td>Jusqu'a 7 bar (SDR 11 PE100)</td><td>Soudeur PE niveau T4 requis</td></tr></tbody></table><ul class=\"checklist\"><li>Rayon de cintrage minimum: 25 x DN pour tube non chauffee.</li><li>Controle visuel des collerettes apres electrofusion.</li><li>Detecter et reperez toutes les soudures avant remblai.</li><li>Preparer un plan de recollement georeference.</li></ul></div>",
          resources: [
            { label: "NF EN 1555-2 reseaux gaz PE", type: "norme" },
            { label: "Guide technique GRDF - Pose PE moyenne pression", type: "guide" },
            { label: "Memento soudage PE electrofusion", type: "memento" }
          ],
          followUps: ["Comment preparer une soudure PE", "Quand passer en acier", "Controle a chaud apres remise en gaz"]
        },
        {
          id: "diam-cuivre",
          title: "Canalisations cuivre interieur",
          category: "Diametres",
          keywords: ["diametre cuivre", "cuivre gaz", "plomberie gaz", "brasage", "tuyau cuivre"],
          summary: "Cuivre recuit NF EN 1057. Diametres exterieurs 12, 14, 18, 22, 28 et 35 mm courant.",
          details: "<div class=\"answer-section\"><div class=\"bot-section-title\">Dimensionnement indicatif</div><table class=\"data-table\"><thead><tr><th>Usage</th><th>Diametre ext</th><th>Longueur max (m)</th><th>Remarques</th></tr></thead><tbody><tr><td>Appareil individuel &lt; 2,5 m3/h</td><td>12</td><td>15</td><td>Brasage fort obligatoire</td></tr><tr><td>Chaudiere collective 4 m3/h</td><td>18</td><td>25</td><td>Support tous les 1,5 m</td></tr><tr><td>Colonne montante 6 m3/h</td><td>22</td><td>40</td><td>Integre un organe de coupure</td></tr><tr><td>Tronc principal &gt; 10 m3/h</td><td>28 ou 35</td><td>Selon calcul</td><td>Raccorder via lyre acier</td></tr></tbody></table><ul class=\"checklist\"><li>Installer coupe-gaz accessible et etiquettee.</li><li>Eviter toute soudure tendre (etain) pour le gaz.</li><li>Ventiler les gaines techniques.</li><li>Tester a la pression 150 mbar pendant 10 min minimum.</li></ul></div>",
          resources: [
            { label: "NF DTU 61.1 - Installations gaz dans les locaux", type: "norme" },
            { label: "Guide GRDF GAZPAR - raccordements cuivre", type: "guide" }
          ],
          followUps: ["Quelle longueur maxi en apparent", "Quels EPI pour brasage", "Transition cuivre acier"]
        },
        {
          id: "diam-acier",
          title: "Tubes acier soudables",
          category: "Diametres",
          keywords: ["diametre acier", "tubes acier", "dn", "epaisseur acier", "soudage acier"],
          summary: "Acier S235 ou API5L avec revetement interne. DN 25 a 200 courant. Calculer selon debit, pression et vitesse cible (< 6 m/s).",
          details: "<div class=\"answer-section\"><div class=\"bot-section-title\">Tableau DN acier</div><table class=\"data-table\"><thead><tr><th>DN</th><th>Diam ext (mm)</th><th>Epaisseur (mm)</th><th>Usage</th></tr></thead><tbody><tr><td>DN 25</td><td>33,7</td><td>3,2</td><td>Poste cabine ou branchement renforce</td></tr><tr><td>DN 40</td><td>48,3</td><td>3,2</td><td>Collecteur basse pression</td></tr><tr><td>DN 65</td><td>76,1</td><td>4,0</td><td>Renforcement distribution</td></tr><tr><td>DN 100</td><td>114,3</td><td>4,5</td><td>Tronc principal moyenne pression</td></tr><tr><td>DN 150</td><td>168,3</td><td>4,5</td><td>Liaison interreseaux</td></tr></tbody></table><ul class=\"checklist\"><li>Controle magnetoscopique ou radiographique selon classe de soudure.</li><li>Protection cathodique si pose en sol agressif.</li><li>Peinture epoxy ou gaine thermo retractable sur zones soudes.</li><li>Prevoir epreuves a 1,5 fois la pression de service.</li></ul></div>",
          resources: [
            { label: "NF EN ISO 3183 - Tubes acier pour gaz", type: "norme" },
            { label: "Guide soudage acier gaz GESIP", type: "guide" }
          ],
          followUps: ["Comment gerer la reprise sur fonte", "Controle radiographique obligatoire", "Protection cathodique"]
        },
        {
          id: "diam-plomb",
          title: "Anciennes canalisations en plomb",
          category: "Materiaux",
          keywords: ["plomb", "reseau existant", "remplacement plomb", "diametre plomb"],
          summary: "Les conduites plomb subsistent sur certains anciens branchements (diametre 14x16, 20x22). Remplacement systematique recommande lors d'une intervention.",
          details: "<div class=\"answer-section\"><p>Identifier la presence de plomb via detecteur ou inspection visuelle (aspect gris mat, soudure a l'etain). Planifier une bascule en PE ou cuivre avec organe de coupure conforme.</p><ul class=\"checklist\"><li>Informer le client et tracer la fiche patrimoine.</li><li>Isoler la conduite et aspirer eventuel residu avant coupe.</li><li>Mettre a la terre les parties metalliques voisines.</li><li>Evacuer le materiel en dechetterie agreee (bordereau).</li></ul></div>",
          resources: [
            { label: "Instruction GRDF I-Reseau 12 - abandon plomb", type: "guide" }
          ],
          followUps: ["Procede de remplacement plomb", "Contrats de concession"]
        },
        {
          id: "choix-materiau",
          title: "Choisir le materiau",
          category: "Materiaux",
          keywords: ["choix materiau", "reprendre acier", "remplacement", "compatible", "flexible"],
          summary: "Selectionner le materiau selon pression, exposition UV, zone de raccord et exigence reglementaire. Favoriser PE pour reseau enterre et acier pour sortie de sol.",
          details: "<div class=\"answer-section\"><ul class=\"checklist\"><li><strong>PE</strong>: reseaux basse/moyenne pression enterres, rayon de cintrage important, soudure bout a bout ou electrofusion.</li><li><strong>Acier</strong>: sections apparentes, postes de regulation, zones fortes contraintes mecanique.</li><li><strong>Cuivre</strong>: distribution interieure, gaines ventilees, brasage fort.</li><li><strong>Fonte ou inox</strong>: cas particulier patrimoine ou zone corrosive.</li></ul><p>Les transitions PE/acier s'effectuent par piece d'appareillage prefabriee (bicone, raccord mixte). Controle d'etancheite systematique apres assemblage.</p></div>",
          resources: [
            { label: "Catalogue raccords mixtes GRDF", type: "memento" }
          ],
          followUps: ["Transition PE acier", "Quand utiliser lyre inox"]
        },
        {
          id: "travaux-publics",
          title: "Travaux publics - obligations majeures",
          category: "Reglementation",
          keywords: ["travaux publics", "dict", "gu", "aipr", "marquage piketti", "plan prevention"],
          summary: "Avant tout chantier a proximite d'un reseau gaz, respecter le triptyque DICT, marquage-piquetage et surveillance. Chef de chantier habilite AIPR.",
          details: "<div class=\"answer-section\"><ol class=\"step-list\"><li><strong>DICT / DT > 15 jours</strong>: declarer l'intervention via reseau info travaux (JO). Attendre la reponse exploitant.</li><li><strong>Analyse des plans</strong>: identifier zone d'incertitude, proximite d'ouvrage sensible.</li><li><strong>Marquage-piquetage</strong>: tracage sur sol selon norme NF S70-003-1, couleur jaune gaz.</li><li><strong>Detection</strong>: radio-detection, localisation precise avant mecanisation.</li><li><strong>Mode operatoire</strong>: pelle mecanique seulement apres decapage manuel 40 cm.</li><li><strong>Surveillance GRDF</strong>: presence obligatoire si risque 1 ou intervention complexe.</li></ol><p>Consigner les operations dans le registre de chantier et conserver la DICT a bord de vehicule.</p></div>",
          resources: [
            { label: "Code de l'environnement - articles R554-1 a R554-42", type: "norme" },
            { label: "NF S 70-003-1 marquage au sol", type: "norme" },
            { label: "Guide travaux a proximite des reseaux (GTPR)", type: "guide" }
          ],
          followUps: ["Comment preparer une DICT", "Plan de prevention type gaz"]
        },
        {
          id: "securite",
          title: "Securite chantier gaz",
          category: "Securite",
          keywords: ["epi gaz", "securite", "perimetre", "vigipoche", "detecteur"],
          summary: "Port des EPI specifiques, detection gaz permanente et controle du perimetre. Mise a la terre des engins et verification ATEX.",
          details: "<div class=\"answer-section\"><ul class=\"checklist\"><li>Casque, gants anticoupure, lunettes, vetements ignifuges et chaussures S3.</li><li>Controle de la teneur en gaz avec detecteur 4 gaz en continu.</li><li>Interdiction de flamme nue et zone ATEX delimitee.</li><li>Ventilation et mise a la terre avant degazage.</li><li>Brief securite quotidien (5 minutes) avec equipe.</li></ul></div>",
          resources: [
            { label: "Referentiel securite GRDF chantier reseau", type: "guide" },
            { label: "Fiche reflexe ATEX niveau 1", type: "memento" }
          ],
          followUps: ["Check EPI", "Detecteur gaz a utiliser"]
        },
        {
          id: "procedure-fuite",
          title: "Fuite gaz sur chantier",
          category: "Securite",
          keywords: ["fuite", "urgence", "evacuation", "sirene", "perimetre"],
          summary: "Arreter immediatement les travaux, securiser la zone et alerter le PC securite. Respecter la chaine d'appel GRDF.",
          details: "<div class=\"answer-section\"><ol class=\"step-list\"><li>Coupure rapide: fermer organes, eteindre moteurs, couper electricite locale.</li><li>Perimetre 50 m minimum, evacuer riverains sous controle forces ordre.</li><li>Appeler le PC securite GRDF et les secours (112) en indiquant DICT et repere plan.</li><li>Mettre en place brumisation si emission importante.</li><li>Tracer les faits et conserver temoignages.</li></ol><p>Reprise travaux uniquement apres autorisation ecrite du responsable exploitation.</p></div>",
          resources: [
            { label: "Fiche reflexe fuite gaz chantier", type: "memento" }
          ],
          followUps: ["Quels numeros appeler", "Quand lever le perimetre"]
        },
        {
          id: "mise-en-gaz",
          title: "Checklist mise en gaz",
          category: "Procedure",
          keywords: ["mise en gaz", "epreuve", "controle pression", "verif etancheite"],
          summary: "Respecter sequence: purge, epreuve, mise en gaz progressive et controle d'etancheite. Documenter chaque etape.",
          details: "<div class=\"answer-section\"><ul class=\"checklist\"><li>Epreuve d'etancheite 1,5 x pression service (minimum 1 bar) pendant 1 h.</li><li>Verification appareillage (robinets, organes de securite, soupapes).</li><li>Purge a l'azote ou a l'air, puis introduction gaz lentement.</li><li>Controle olfactif et detecteur sur toutes soudures.</li><li>Remise de la fiche de mise en service au client/exploitant.</li></ul></div>",
          resources: [
            { label: "Formulaire mise en gaz GRDF", type: "memento" },
            { label: "NF EN 1775 distribution gaz int", type: "norme" }
          ],
          followUps: ["Pression d'epreuve", "Documents a remettre"]
        },
        {
          id: "controle-qualite",
          title: "Controle qualite chantier",
          category: "Procedure",
          keywords: ["controle qualite", "pv", "recollement", "audit"],
          summary: "Verifier dossiers, photos, georeferencement et PV d'epreuve avant cloture chantier.",
          details: "<div class=\"answer-section\"><ul class=\"checklist\"><li>PV d'epreuve signe et archive.</li><li>Plan de recollement au format SIG avec coordonnees x/y/z.</li><li>Photos geolocalisees des soudures et protections.</li><li>Controle de compaction tranchee avant remise a la voirie.</li><li>Decharger les DASRI et dechets selon filieres.</li></ul></div>",
          resources: [
            { label: "Procedure GRDF dossier ouvrage execute", type: "guide" }
          ],
          followUps: ["Contenu dossier DOE", "Georeferencement A classe"]
        },
        {
          id: "documents",
          title: "Documentation cle",
          category: "Reglementation",
          keywords: ["documentation", "normes", "referentiel", "guide"],
          summary: "Principales references normatives pour reseaux et installations gaz.",
          details: "<div class=\"answer-section\"><ul class=\"lead-list\"><li>NF EN 1555 - Reseaux PE.</li><li>NF EN ISO 3183 - Tubes acier.</li><li>NF DTU 61.1 - Installations gaz.</li><li>Guide travaux a proximite des reseaux (GTPR).</li><li>Guide GRDF - Prevention ATEX chantier.</li></ul></div>",
          resources: [
            { label: "Portail documentation technique GRDF", type: "guide" }
          ],
          followUps: ["Ou trouver les guides", "Derniere version NF DTU 61.1"]
        }
      ];

      const persistentQuickReplies = [
        { label: "Planifier DICT", query: "Comment preparer une DICT travaux gaz" },
        { label: "Transition PE / acier", query: "Transition PE acier sur sortie de sol" },
        { label: "Epreuve de pression", query: "Pression d'epreuve mise en gaz" },
        { label: "Controle de soudure", query: "Controle des soudures PE" },
        { label: "Liste EPI", query: "EPI obligatoires chantier gaz" }
      ];

      let typingTimeout = null;

      function normalize(text) {
        return text
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9/\s-]/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      }

      const indexedKnowledge = knowledgeBase.map((article) => ({
        ...article,
        searchable: normalize([article.title, article.summary, article.keywords.join(" "), article.category].join(" "))
      }));
      function findMatches(query) {
        const normQuery = normalize(query);
        if (!normQuery) {
          return [];
        }
        const tokens = normQuery.split(" ");
        return indexedKnowledge
          .map((article) => {
            let score = 0;
            if (article.searchable.includes(normQuery)) {
              score += 6;
            }
            article.keywords.forEach((kw) => {
              const normKw = normalize(kw);
              if (!normKw) {
                return;
              }
              if (normQuery.includes(normKw)) {
                score += 5;
              } else if (normKw.includes(normQuery)) {
                score += 3;
              }
            });
            tokens.forEach((token) => {
              if (token.length < 3) {
                return;
              }
              if (article.searchable.includes(token)) {
                score += 1.5;
              }
            });
            if (article.category && normQuery.includes(normalize(article.category))) {
              score += 2;
            }
            return { article, score };
          })
          .filter((item) => item.score > 0)
          .sort((a, b) => b.score - a.score)
          .map((item) => item.article);
      }

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function appendMessage({ role, content, asHtml = false }) {
        const bubble = document.createElement("div");
        bubble.className = `message ${role}`;
        bubble.innerHTML = asHtml ? content : `<p>${escapeHtml(content)}</p>`;
        messagesEl.appendChild(bubble);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        persistHistory();
      }

      function appendTyping() {
        const bubble = document.createElement("div");
        bubble.className = "message bot";
        bubble.dataset.typing = "true";
        bubble.innerHTML = '<div class="typing-indicator" aria-hidden="true"><span></span><span></span><span></span></div>';
        messagesEl.appendChild(bubble);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return bubble;
      }

      function removeTyping(bubble) {
        if (bubble && bubble.parentNode) {
          bubble.parentNode.removeChild(bubble);
        }
      }
      function formatResources(resources) {
        if (!resources || !resources.length) {
          return "";
        }
        const items = resources
          .map((item) => {
            const cls = `badge ${item.type || "guide"}`;
            return `<li><span class="${cls}">${item.type || "ref"}</span>${escapeHtml(item.label)}</li>`;
          })
          .join("");
        return `<div class="related-block"><h5>References utiles</h5><ul class="resource-list">${items}</ul></div>`;
      }

      function buildBotAnswer(query) {
        const matches = findMatches(query);
        if (!matches.length) {
          const tips = knowledgeBase.slice(0, 4)
            .map((article) => `<button type="button" data-query="${escapeHtml(article.title)}">${escapeHtml(article.title)}</button>`)
            .join("");
          return `
            <div class="answer-section">
              <h4>Je n'ai pas encore la fiche precise</h4>
              <p>Reformulez avec les mots cle suivants: diametre, type de materiau (PE, acier, cuivre), procedure, DICT, fuite.</p>
              <div class="related-block">
                <h5>Suggestions</h5>
                ${tips}
              </div>
              <div class="disclaimer">Ces informations ne remplacent pas la documentation officielle GRDF. Verifiez toujours avec votre referent technique.</div>
            </div>`;
        }
        const best = matches[0];
        const related = matches.slice(1, 4);
        const followUps = best.followUps || [];
        return `
          <div class="answer-section">
            <h4>${escapeHtml(best.title)}</h4>
            <p>${escapeHtml(best.summary)}</p>
            ${best.details || ""}
            ${formatResources(best.resources)}
            ${followUps.length ? `<div class="related-block"><h5>Pour aller plus loin</h5>${followUps.map((item) => `<button type=\"button\" data-query=\"${escapeHtml(item)}\">${escapeHtml(item)}</button>`).join("")}</div>` : ""}
            ${related.length ? `<div class="related-block"><h5>Autres fiches liees</h5>${related.map((item) => `<button type=\"button\" data-query=\"${escapeHtml(item.title)}\">${escapeHtml(item.title)}</button>`).join("")}</div>` : ""}
            <div class="disclaimer">Toujours verifier les contraintes locales (pression, concession, autorisations) avant execution.</div>
          </div>`;
      }
      function persistHistory() {
        const history = Array.from(messagesEl.children).map((node) => ({
          role: node.classList.contains("user") ? "user" : "bot",
          html: node.innerHTML
        }));
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        } catch (error) {
          console.warn("Impossible de sauvegarder l'historique", error);
        }
      }

      function loadHistory() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            return;
          }
          const history = JSON.parse(raw);
          history.forEach((item) => {
            const bubble = document.createElement("div");
            bubble.className = `message ${item.role}`;
            bubble.innerHTML = item.html;
            messagesEl.appendChild(bubble);
          });
          messagesEl.scrollTop = messagesEl.scrollHeight;
        } catch (error) {
          console.warn("Historique inutilisable", error);
          localStorage.removeItem(STORAGE_KEY);
        }
      }

      function renderQuickReplies() {
        quickRepliesEl.innerHTML = persistentQuickReplies
          .map((item) => `<button type="button" data-query="${escapeHtml(item.query)}">${escapeHtml(item.label)}</button>`)
          .join("");
      }

      function renderPanelCards() {
        panelBody.innerHTML = knowledgeBase
          .map((article) => `
            <article class="panel-card">
              <h3>${escapeHtml(article.title)}</h3>
              <p>${escapeHtml(article.summary)}</p>
              <button type="button" data-query="${escapeHtml(article.title)}">Afficher dans le chat</button>
            </article>`
          )
          .join("");
      }
      function showAutocomplete(value) {
        const normValue = normalize(value);
        if (!normValue || normValue.length < 3) {
          autocompleteEl.style.display = "none";
          autocompleteEl.innerHTML = "";
          return;
        }
        const hits = knowledgeBase
          .filter((article) => normalize(article.title).includes(normValue) || article.keywords.some((kw) => normalize(kw).includes(normValue)))
          .slice(0, 5);
        if (!hits.length) {
          autocompleteEl.style.display = "none";
          autocompleteEl.innerHTML = "";
          return;
        }
        autocompleteEl.innerHTML = hits
          .map((article) => `<button type="button" data-query="${escapeHtml(article.title)}">${escapeHtml(article.title)}</button>`)
          .join("");
        autocompleteEl.style.display = "flex";
      }

      function clearInput() {
        userInput.value = "";
        userInput.style.height = "auto";
        autocompleteEl.style.display = "none";
        autocompleteEl.innerHTML = "";
      }
      function processUserMessage(rawText) {
        const text = rawText.trim();
        if (!text) {
          return;
        }
        if (text === "/reset") {
          messagesEl.innerHTML = "";
          localStorage.removeItem(STORAGE_KEY);
          appendMessage({ role: "bot", content: "Conversation remise a zero. Comment puis-je vous aider ?" });
          return;
        }
        appendMessage({ role: "user", content: text });
        clearInput();
        const typingBubble = appendTyping();
        window.clearTimeout(typingTimeout);
        typingTimeout = window.setTimeout(() => {
          removeTyping(typingBubble);
          const answer = buildBotAnswer(text);
          appendMessage({ role: "bot", content: answer, asHtml: true });
        }, Math.min(2600, 800 + text.length * 40));
      }

      sendButton.addEventListener("click", () => {
        processUserMessage(userInput.value);
      });

      userInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          processUserMessage(userInput.value);
        }
      });

      userInput.addEventListener("input", () => {
        userInput.style.height = "auto";
        userInput.style.height = `${userInput.scrollHeight}px`;
        showAutocomplete(userInput.value);
      });
      autocompleteEl.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-query]");
        if (!button) {
          return;
        }
        processUserMessage(button.dataset.query);
      });

      quickRepliesEl.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-query]");
        if (!button) {
          return;
        }
        processUserMessage(button.dataset.query);
      });

      topicsTray.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-query]");
        if (!button) {
          return;
        }
        processUserMessage(button.dataset.query);
      });

      panelBody.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-query]");
        if (!button) {
          return;
        }
        panel.classList.remove("open");
        openPanelBtn.setAttribute("aria-expanded", "false");
        processUserMessage(button.dataset.query);
      });

      messagesEl.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-query]");
        if (!button) {
          return;
        }
        processUserMessage(button.dataset.query);
      });
      openPanelBtn.addEventListener("click", () => {
        const isOpen = panel.classList.toggle("open");
        panel.setAttribute("aria-hidden", String(!isOpen));
        openPanelBtn.setAttribute("aria-expanded", String(isOpen));
      });

      closePanelBtn.addEventListener("click", () => {
        panel.classList.remove("open");
        panel.setAttribute("aria-hidden", "true");
        openPanelBtn.setAttribute("aria-expanded", "false");
      });

      renderQuickReplies();
      renderPanelCards();
      loadHistory();

      if (!messagesEl.children.length) {
        appendMessage({
          role: "bot",
          content: `Bienvenue ! Indiquez un materiau ou une procedure (ex. \"Diametre PE pour 40 m\"). Tapez /reset pour effacer l'historique.`,
          asHtml: true
        });
      }
    })();
  </script>
</body>
</html>
